---
title: "Study 1 - Validating the Heart Manikin"
output: 
  html_notebook: 
    code_folding: hide
---

In Study 1, I validate the Heart Manikin. The dataset that will be included are:

1.  Mass Testing Survey Data from Fall 2018 (RPR)
2.  RAIv1
3.  ARv1
4.  EVv1
5.  NPSv2

```{r setup}
# Load packages
library(here)
library(tidyverse)
library(labelled) # Handling variable labels
library(codebook)

# User functions
add_labels_nts <- function(x) {
  val_labels(x) <- c("The least I could ever possibly feel" = 0,
                     "The most I could ever possibly feel" = 100)
  return(x)
}

```

------------------------------------------------------------------------

# Study 1a: RPR Study

## Load Data and Select Variables

```{r RPR}
RPR_raw <- read_csv(here("data", "RPR", "RPR_raw.csv"), col_types = cols()) %>%
  slice(-1, -2) %>% 
  # only the people who are in the block to answer the questions
  filter(batch == "1")

# Specify Public Variables
RPR_public_variables <- list(
  id = "id",
  StartDate = "StartDate",
  EndDate = "EndDate",
  finished = "Finished",
  heart = "Q122", # Heart Manikin
  valence = "Q121", # Valence Manikin
  social_isolation = paste0("promisSI_", 1:8), # PROMIS Social Isolation
  CESD = paste0("cesd_", 1:20), # CESD
  bio_diff = paste0("Q123_", 1:15), # Beliefs about Biological Differences between Blacks and Whites - Hoffman
  reactivity = paste0("Q183_", 1:28),
  # Interpersonal Reactivity Index
  self_monitoring = c(paste0("Q", 209:230), paste0("Q", 232:233)), # Self Monitoring (*no q in 231)
  paradoxical_mindset = paste0("Q", 235:243), # Paradoxical Mindset
  integrative_complexity = paste0("Q", 245:255), # Integrative Complexity
  multiple_identity = paste0("Q", 262:265) # Multiple Identity Scale
)

# Select Only the Variables Needed 
RPR_public <- RPR_raw %>%
  select(unlist(RPR_public_variables))
```

## Recoding Values

```{r RPR Cleaning Values}
# Convert Dates 
RPR_public <- RPR_public %>% 
  mutate(across(c(StartDate, EndDate),
                lubridate::as_datetime))

# Heart Manikin & Valence Manikin
RPR_public <- RPR_public %>% 
  mutate(heart = as.numeric(str_sub(heart, -1, -1)), # last character is the number
         valence = as.numeric(str_sub(valence, -1, -1))) %>%
  # CESD - The last character is the number
  mutate(across(starts_with("CESD"),
                function(x){as.numeric(str_sub(x, -1, -1))})) %>%
  # PROMIS - Get the last character showing a number
  mutate(across(starts_with("social_isolation"), 
                function(x){as.numeric(str_sub(x, -1, -1))})) %>%
  # Beliefs About Biological Differences
  mutate(across(starts_with("bio_diff"),
                function(x){
                  case_when(x == "Definitely untrue" ~ 1,
                            x == "Probably untrue" ~ 2,
                            x == "Possibly untrue" ~ 3,
                            x == "Possibly true" ~ 4,
                            x == "Probably true" ~ 5,
                            x == "Definitely true" ~ 6)
                })) %>%
  # Interpersonal Reactivity Scale
  mutate(across(starts_with("reactivity"),
                function(x){case_when(x == "Does not describe me well  (A)" ~ 0,
                                      x == "(B)" ~ 1,
                                      x == "(C)" ~ 2,
                                      x == "(D)" ~ 3,
                                      x == "Describes me very well  (E)" ~ 4)}))


# Paradox Mindset (note there is a multiple spaces for the answer 5)
RPR_public <- RPR_public %>% 
  mutate(across(starts_with("paradoxical_mindset"),
                .fns = function(x){case_when(x == "Strongly disagree" ~ 1,
                                             x == "Disagree" ~ 2,
                                             x == "Slightly disagree" ~ 3,
                                             x == "Neither agree nor disagree" ~ 4,
                                             x == "Slightly     agree" ~ 5,
                                             x == "Agree" ~ 6,
                                             x == "Strongly agree" ~ 7)}))

# Integrative Complexity
RPR_public <- RPR_public %>% 
  mutate(across(starts_with("integrative_complexity"),
                .fns = function(x){case_when(x == "Strongly disagree" ~ 1,
                                             x == "Disagree" ~ 2,
                                             x == "Slightly disagree" ~ 3,
                                             x == "Neither agree nor disagree" ~ 4,
                                             x == "Slightly agree" ~ 5,
                                             x == "Agree" ~ 6,
                                             x == "Strongly agree" ~ 7)}))

# Multiple Identity
RPR_public <- RPR_public %>% 
  mutate(across(starts_with("multiple_identity"),
                .fns = function(x){case_when(x == "Do not agree at all (1)" ~ 1,
                                             x == "Agree completely (7)" ~ 7,
                                             TRUE ~ as.numeric(x))}))

```

## Labels for Variables and Values

```{r}
write_csv(tibble(varname = colnames(RPR_public)),
  here("codebooks/RPR_codebook.csv"))

# Read the dictionary from Web
RPR_dict_dir <- here("data", "RPR", "RPR_vars_dictionary.csv")

RPR_dict <- read_csv(RPR_dict_dir, col_type = cols())
var_label(RPR_public) <- RPR_dict %>% 
  select(varname, label) %>% 
  dict_to_list()

 
# Heart 
add_labels_heart <- function(x) {
  val_labels(x) <- c("lonely, rejected, isolated, disconnected" = 1, "2" = 2,
                     "3" = 3, "4" = 4, "5" = 5, "6" = 6, "7" = 7, "8" = 8,
                     "cared for, accepted, loved, connected" = 9)
  return(x)
}
RPR_public <- RPR_public %>%
  mutate_at("heart",
            add_labels_heart)

# Valence
add_labels_valence <- function(x) {
  val_labels(x) <- c("unhappy, annoyed, unsatisfied, bored" = 1,
                     "2" = 2, "3" = 3, "4" = 4,
                     "5" = 5, "6" = 6, "7" = 7,
                     "8" = 8, "9" = 9,
                     "happy, pleased, satisfied, hopeful" = 10)
  return(x)
}
RPR_public <- RPR_public %>%
  mutate_at("valence",
            add_labels_valence)

# Social Isolation
add_likert_never_always5 <- function(x) {
  val_labels(x) <- c("Never" = 1,
                      "Rarely" = 2,
                      "Sometimes" = 3,
                      "Usually" = 4,
                      "Always" = 5)
  return(x)
}
RPR_public <- RPR_public %>%
  mutate_at(vars(social_isolation1:social_isolation8),
            add_likert_never_always5)

# CESD
add_likert_CESD <- function(x) {
  val_labels(x) <- c("Rarely or none of the time" = 0,
                     "Some or a little of the time (1-2 days) " = 1,
                     "Occasionally or a moderate amount of time (3-4 days) " = 2,
                     "Most or all of the time" = 3)
  return(x)
}

RPR_public <- RPR_public %>%
  mutate_at(vars(CESD1:CESD20),
            add_likert_CESD)

# Beliefs about Biological Differences between Blacks and Whites Scale
add_likert_beliefs <- function(x) {
  val_labels(x) <- c("Definitely untrue" = 1,
                     "Probably untrue" = 2,
                     "Possibly untrue" = 3,
                     "Possibly true" = 4,
                     "Probably true" = 5,
                     "Definitely true" = 6)
  return(x)
}
RPR_public <- RPR_public %>%
  mutate_at(vars(bio_diff1:bio_diff15),
            add_likert_beliefs)


# Interpersonal Reactivity
add_likert_reactivity <- function(x) {
  val_labels(x) <- c("Does not describe me well" = 0,
                     "1" = 1,
                     "2" = 2,
                     "3" = 3,
                     "Describes me very well" = 4)
  return(x)
}
RPR_public <- RPR_public %>%
  mutate_at(vars(reactivity1:reactivity28),
            add_likert_reactivity)

# Self-Monitoring
add_tf_self_monitoring <- function(x) {
  val_labels(x) <- c("T" = "T",
                     "F" = "F")
  return(x)
}

RPR_public <- RPR_public %>%
  mutate_at(vars(self_monitoring1:self_monitoring24),
            add_tf_self_monitoring)

# Paradox Mindset
add_likert_SDSA17 <- function(x) {
  val_labels(x) <- c("Strongly disagree" = 1,
                     "Disagree" = 2,
                     "Slightly disagree" = 3,
                     "Neither agree nor disagree" = 4,
                     "Slightly agree" = 5,
                     "Agree" = 6,
                     "Strongly agree" = 7)
  return(x)
}

RPR_public <- RPR_public %>%
  mutate_at(vars(paradoxical_mindset1:paradoxical_mindset9),
            add_likert_SDSA17)

# Integrative Complexity
RPR_public <- RPR_public %>%
  mutate_at(vars(integrative_complexity1:integrative_complexity11),
            add_likert_SDSA17)

# Multiple Identity
# 1 Do not agree at all 2 3 4 5 6 7 Agree completely
add_likert_multiple_identity <- function(x) {
  val_labels(x) <- c("Do not agree at all" = 1,
                     "2" = 2,
                     "3" = 3,
                     "4" = 4,
                     "5" = 5,
                     "6" = 6,
                     "Agree completely" = 7)
  return(x)
}
RPR_public <- RPR_public %>%
  mutate_at(vars(multiple_identity1:multiple_identity4),
            add_likert_multiple_identity)
```

## Reverse Coding

```{r RPR Recoding Values}
# Reverse Coding

# CESD - Reverse Code
CESD_rev <- c(4, 8, 12, 16)
CESD_non_rev <- (1:20)[!(1:20 %in% CESD_rev)] 
CESD_rev_vars <- paste0("CESD", CESD_rev)
CESD_vars <- paste0("CESD", c(paste0(CESD_rev, "R"), CESD_non_rev))
## Add "R" to reversed variable names
RPR_public <- RPR_public %>% 
  rename_at(CESD_rev_vars, add_R)
## Reverse the values of the reversed variables with "R"
RPR_public <- RPR_public %>%
  mutate_at(paste0(CESD_rev_vars, "R"), reverse_labelled_values)

# Interpersonal Reactivity Scale - Reverse Code
reactivity_rev_vars <- paste0("reactivity", c(3, 4, 7, 12, 13, 14, 15, 18, 19))
RPR_public <- RPR_public %>% 
  # Add R
  rename_at(reactivity_rev_vars, add_R) %>% 
  mutate_at(paste0(reactivity_rev_vars, "R"), reverse_labelled_values)

# Self-Monitoring Scale 
self_monitor_f <- paste0("self_monitoring",
                         c(1, 2, 3, 4, 9,
                           12, 14, 17, 20, 21,
                           22))
self_monitor_t <- paste0("self_monitoring", 1:24)[!(paste0("self_monitoring", 1:24) %in% self_monitor_f)]
self_monitor_f <- self_monitor_f[self_monitor_f != "self_monitoring23"]
self_monitor_scores_vars <- paste0(c(self_monitor_t, self_monitor_f), "_score")

RPR_public <- RPR_public %>%
  # Save original string as raw_
  mutate(across(all_of(self_monitor_f),
                function(x){case_when(x == "F" ~ 1,
                                      x == "T" ~ 0)},
                .names = "{col}_score")) %>%
  mutate(across(all_of(self_monitor_t),
                function(x){case_when(x == "T" ~ 1,
                                      x == "F" ~ 0)},
                .names = "{col}_score"))

## Assign Value Labels
# to F = 1
add_tf_f1t0 <- function(x) {
  val_labels(x) <- c("F" = 1,
                     "T" = 0)
  return(x)
}
RPR_public <- RPR_public %>%
  mutate_at(all_of(paste0(self_monitor_f, "_score")),
            add_tf_f1t0)
# to T = 1
add_tf_f0t1 <- function(x) {
  val_labels(x) <- c("F" = 0,
                     "T" = 1)
  return(x)
}
RPR_public <- RPR_public %>%
  mutate_at(all_of(paste0(self_monitor_t, "_score")),
            add_tf_f0t1)

# Paradox Mindset Scale - No Recoding Needed 

# Integrative Complexity Scale - No Recoding Needed

# Multiple Identity Scale - No recoding needed


```

## Calculate Scale Scores

```{r Study 1a - Calculate Scale Scores}
# Indices Calculations

# CESD 
RPR_public$CESD_sum <- RPR_public %>% 
  select(all_of(CESD_vars)) %>%
  aggregate_and_document_scale(fun = rowSums)

# Social Isolation
RPR_public$social_isolation_mean <- RPR_public %>%
  select(social_isolation1:social_isolation8) %>%
  aggregate_and_document_scale # Mean

# Beliefs on Biological Differences
# Exclude the true differences questions:
# 12 (heart disease), 13 (spinal cord disease),
# 14 (bone), 15 (stroke) are true differences, and thus excluded
RPR_public$bio_diff_mean <- RPR_public %>%
  select("bio_diff1":"bio_diff11") %>%
  aggregate_and_document_scale # Mean

# Interpersonal Reactivity Index
reactivity_rev <- c(3, 4, 7, 12, 13, 14, 15, 18, 19) # Items to be reverse-coded
reactivity_non_rev <- (1:28)[!(1:28 %in% reactivity_rev)] # Other Items
reactivity_vars <- paste0("reactivity",
                          c(paste0(reactivity_rev, "R"),
                            reactivity_non_rev)) # Combine
# RPR_public <- RPR_public %>% 
#   rowwise() %>%
#   mutate(reactivity_mean = mean(c_across(all_of(reactivity_vars))))

RPR_public$reactivity_mean <- RPR_public %>% 
  select(all_of(reactivity_vars)) %>%
  aggregate_and_document_scale()


# Self-Monitoring Scale
RPR_public$self_monitoring_sum <- RPR_public %>% 
  select(all_of(self_monitor_scores_vars)) %>%
  aggregate_and_document_scale(fun = rowSums)

# Paradox Mindset Scale
RPR_public$paradoxical_mindset_mean <- RPR_public %>% 
  select(paradoxical_mindset1:paradoxical_mindset9) %>% 
    aggregate_and_document_scale()

# Integrative Complexity Scale
RPR_public$integrative_complexity_mean <- RPR_public %>% 
  select(integrative_complexity1:integrative_complexity11) %>% 
    aggregate_and_document_scale()

# Multiple Identity Scale
RPR_public$multiple_identity_mean <- RPR_public %>% 
  select(multiple_identity1:multiple_identity4) %>% 
  aggregate_and_document_scale()

```

```{r s1a-saving-reliabilities}
# save reliability object for caching
s1a_reliability_data <- RPR_public %>% 
  compute_reliabilities() %>% get_reliability_output()
# compress and save (otherwise 5GB < file size)
s1a_reliability_data %>% 
  write_rds(here("data_public", "reliability", "s1a_reliability.rds"), compress = "gz")
```

## Save the Public Dataset

```{r save}
# csv
write_csv(RPR_public, here("data_public/Study1a_public.csv"))

# rds
write_rds(RPR_public, here("data_public/Study1a_public.rds"))
```

------------------------------------------------------------------------

# Study 1b - RAIv1

## Load Data and Select Variables

```{r RAIv1}
# Read the dataset
RAIv1_raw <- read_csv(here("data/RAIv1/RAIv1 Visit 1,2,3 RAW MERGED Data 12_14_16.csv"),
                      col_types = cols()) # Auto Col Types

# Mask Participant ID since some students had their student ID
RAIv1_raw <- RAIv1_raw %>%
  mutate(FLEENID = case_when(FLEENID == 702221983 ~ 983,
                             FLEENID == 702248402 ~ 402,
                             FLEENID == 702302055 ~ 055,
                             TRUE ~ FLEENID))

# Variables Needed 
RAIv1_public_vars <- list(
  # Start Date
  StartDate = "StartDate",
  EndDate = "EndDate",
  # Participant ID
  id = "FLEENID",
  # Visit #
  visit = "Visit",
  # Gender (1 == Male, 2 == Female)
  gender = "demo1",
  # Age 
  age = "demo5",
  # Race (1 American Indian, 2 White, 3 Other, 4 African-American, 5 Asian/Pacific Islander)
  race = "demo6",
  # Latino? (1 = No, 2 = Yes)
  hispanic = "demo7", 
  # Ladder - Social Status
  ladder = "demo19b",
  # Relationship Status
  same = "same",
  ex = "ex",
  new = "new", 
  # Heart Manikin
  heart = "manikin2",
  # Valence Manikin
  valence = "manikin1",
  # PROMIS SCALES
  PROMIS_isolation = paste0("promissi_", 1:8), # PROMIS Social Isolation
  PROMIS_emotional = paste0("promises_", 1:8), # PROMIS Emotional Support
  PROMIS_informational = paste0("promisis_", 1:8), # PROMIS Informational Support
  # Couple Satisfaction Index
  # Current
  couples_satisfaction = paste0("csi", 1:4),
  # EX
  couples_satisfaction_EX = paste0("csi", 1:4, "EX"),
  # Inclusion of Other in Self
  IOS = "IOS",
  # Partner Responsiveness
  partner_resp = paste0("ppr_", 1:3),
  # Relationship Conflict Scale
  conflict = paste0("conflict_", 1:3),
  # Ostracism from Romantic Partner Scale
  ostracism = paste0("ostracism_", 1:10),
  # Abusive Behavior Inventory
  abuse_psychological = paste0("ABI_", c(1:11, 23)),
  abuse_physical = paste0("ABI_", c(12:22)),
  # Control Behavior Scale
  control_economic = paste0("CBS_", c(1:4)),
  control_threats = paste0("CBS_", c(5:8)),
  control_intimidation = paste0("CBS_", c(9:13)),
  control_emotional = paste0("CBS_", c(14:18)),
  control_isolation = paste0("CBS_", c(19:24)),
  # Food Craving
  food_craving = paste0("fcq_", c(1:27)),
  # Dietary Social Support,
  dietary_support = paste0("dss_", c(1:9)),
  # Body Image
  body_image = "bodyi",
  # Godin Leisure-Time Exercise Questionnaire
  exercise = paste0("godin", c(1:4)),
  # PROMIS Sleep Disturbance
  sleep = paste0("promissd", c(1:4)),
  # Single-Item Narcissism
  narcissism = "narcissism",
  # Perceived Stress Scale
  stress = paste0("pss_", c(1:10)),
  # CESD - Short-Form
  CESD = paste0("cesd-sf_", 1:10)
)


# Select only the needed variables
RAIv1_public <- RAIv1_raw %>%
  select(unlist(RAIv1_public_vars)) %>% 
  drop_na()
```

## Recode Values

```{r RAIv1 Recode Values}
# Convert Datetime
RAIv1_public <- RAIv1_public %>%
  mutate(across(c(StartDate, EndDate),
                lubridate::mdy_hm))


# Missing values are coded as -89. 
RAIv1_public <- RAIv1_public %>% 
  mutate(across(where(is.numeric), function(x){case_when(x == -89 ~ NA_real_, 
                                                         x != -89 ~ x)}))

# Gender
RAIv1_public <- RAIv1_public %>% 
  mutate(gender = factor(gender, levels = c(1, 2),
                         labels = c("Male", "Female")),
         race = factor(race, levels = 1:5,
                       labels = c("American Indian",
                                  "White/Caucasian",
                                  "Other (specify)",
                                  "African-American",
                                  "Asian/Pacific Islander")))
```

## Labels for Variables and Values

```{r}
write_csv(
  tibble(varname = colnames(RAIv1_public)),
  here("codebooks/RAIv1_variables.csv")
  )


# Read SPSS file and save the labels
RAIv1_SPSS <- haven::read_sav(here("data/RAIv1/RAIv1 All Questionnaires - 9_3_16 (Visit 1)_January 15, 2021_08.12.sav"))

RAIv1_SPSS_labels <- var_label(RAIv1_SPSS) %>% 
  unlist()

RAIv1_SPSS_val_labels <- val_labels(RAIv1_SPSS)


RAIv1_vars <- tibble(var = names(RAIv1_SPSS),
                     label = RAIv1_SPSS_labels,
                     values = RAIv1_SPSS_val_labels)  
RAIv1_vals <- RAIv1_vars %>% unnest(cols = values)

RAIv1_vars %>% select(-values) %>% 
  write_excel_csv(here("codebooks/RAIv1_SPSS_labels.csv"))
write_excel_csv(RAIv1_vals, here("codebooks/RAIv1_SPSS_value_labels.csv"))

# Read the dictionary from Web
RAIv1_dict_URL <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQkFnuVeaQjH2Eey8iItSc9paTvPHcbHz1SEGb6xYo6JYGqIeG8HF1PW2KYiLaacDqBw5-xEH2pfQwU/pub?gid=0&single=true&output=csv"

RAIv1_dict <- read_csv(RAIv1_dict_URL, col_types = cols())
var_label(RAIv1_public) <- RAIv1_dict %>% 
  select(varname, label) %>% 
  dict_to_list()

# Heart Manikin
add_labels_heart <- function(x) {
  val_labels(x) <- c("lonely, rejected, isolated, disconnected" = 1,
                     "2" = 2, "3" = 3, "4" = 4,
                     "5" = 5, "6" = 6, "7" = 7,
                     "8" = 8, "9" = 9,
                     "cared for, accepted, loved, connected" = 10)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at("heart",
            add_labels_heart)

# Valence
add_labels_valence <- function(x) {
  val_labels(x) <- c("unhappy, annoyed, unsatisfied, bored" = 1,
                     "2" = 2, "3" = 3, "4" = 4,
                     "5" = 5, "6" = 6, "7" = 7,
                     "8" = 8, "9" = 9,
                     "happy, pleased, satisfied, hopeful" = 10)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at("valence",
            add_labels_valence)


# PROMIS Scales
add_likert_never_always5 <- function(x) {
  val_labels(x) <- c("Never" = 1,
                     "Rarely" = 2,
                     "Sometimes" = 3,
                     "Usually" = 4,
                     "Always" = 5)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(PROMIS_isolation1:PROMIS_informational8),
            add_likert_never_always5)

# Couples satisfaction
add_likert_couples_happy <- function(x) {
  val_labels(x) <- c("Extremely Unhappy" = 0,
                     "Fairly Unhappy" = 1,
                     "A little Unhappy" = 2,
                     "Happy" = 3,
                     "Very Happy" = 4,
                     "Extremely Happy" = 5,
                     "Perfect" = 6)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at(c("couples_satisfaction1",
              "couples_satisfaction_EX1"),
            add_likert_couples_happy)

### Item 2
add_likert_couples_satisfaction2 <- function(x) {
  val_labels(x) <- c("Not at all" = 1,
                     "A little true" = 2,
                     "Somewhat true" = 3,
                     "Mostly true" = 4,
                     "Almost completely true" = 5,
                     "Completely True" = 6)
  return(x)
}

RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(couples_satisfaction2),
            add_likert_couples_satisfaction2)

RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(couples_satisfaction_EX2),
            add_likert_couples_satisfaction2)

### Items 3 & 4
add_likert_couples_satisfaction34 <- function(x) {
  val_labels(x) <- c("Not at all" = 1,
                     "A little" = 2,
                     "Somewhat" = 3,
                     "Mostly" = 4,
                     "Almost completely" = 5,
                     "Completely" = 6)
  
  return(x)
}


RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(couples_satisfaction3:couples_satisfaction4),
            add_likert_couples_satisfaction34)

RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(couples_satisfaction_EX3:couples_satisfaction_EX4),
            add_likert_couples_satisfaction34)

# Partner Responsiveness
add_likert_partner_resp<- function(x) {
  val_labels(x) <- c("Not at all" = 1,
                     "2" = 2, "3" = 3, "4" = 4,
                     "Very much" = 5)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(partner_resp1:partner_resp3),
            add_likert_couples_happy)


# Conflict 
add_likert_conflict<- function(x) {
  val_labels(x) <- c("Never" = 1, "2" = 2, "3" = 3,
                     "Sometimes" = 4, "5" = 5, "6" = 6,
                     "Regularly" = 7)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(conflict1:conflict3),
            add_likert_conflict)

# Ostracism 
add_likert_ostracism <- function(x) {
  val_labels(x) <- c("Never" = 1, "2" = 2, "3" = 3, "4" = 4, "Always" = 5)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(ostracism1:ostracism10),
            add_likert_ostracism)

# Abusive Behavor Inventory
add_likert_abuse <- function(x) {
  val_labels(x) <- c("Never" = 1, "Rarly" = 2,
                     "Sometimes" = 3, "Often" = 4, "Very Often" = 5)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(abuse_psychological1:abuse_physical11),
            add_likert_abuse)

# Control 
add_likert_control <- function(x) {
  val_labels(x) <- c("Never" = 0, "Rarly" = 1,
                     "Sometimes" = 2, "Often" = 3, "Always" = 4)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(control_economic1:control_isolation6),
            add_likert_control)

# Food Craving
add_likert_food_craving <- function(x) {
  val_labels(x) <- c("Strongly disagree" = 1, "Disagree" = 2,
                     "Neutral" = 3, "Agree" = 4, "Strongly agree" = 5)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(food_craving1:food_craving27),
            add_likert_food_craving)

# Dietary Support
add_likert_dietary_support <- function(x) {
  val_labels(x) <- c("Never or almost never" = 1, "2" = 2,
                     "3" = 3, "4" = 4, "Almost always" = 5)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(dietary_support1:dietary_support9),
            add_likert_dietary_support)

# Body Image
add_likert_body_image <- function(x) {
  val_labels(x) <- c("BMI 17" = 1, "BMI 19" = 2, "BMI 22" = 3,
                     "BMI 24" = 4, "BMI 26" = 5, "BMI 29" = 6,
                     "BMI 33" = 7, "BMI 37" = 8, "BMI 40" = 9)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(body_image),
            add_likert_body_image)

# Sleep
add_likert_sleep_quality <- function(x) {
  val_labels(x) <- c("Very poor" = 1, "Poor" = 2,
                     "Fair" = 3, "Good" = 4, "Very good" = 5)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(sleep1),
            add_likert_sleep_quality)

add_likert_sleep <- function(x) {
  val_labels(x) <- c("Not at all" = 1, "A little bit" = 2,
                     "Somewhat" = 3, "Quite a bit" = 4, "Very much" = 5)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(sleep2:sleep4),
            add_likert_sleep)

# Narcissism
add_likert_narcissism <- function(x) {
  val_labels(x) <- c("Not very true of me" = 1, "2" = 2, "3" = 3,
                     "4" = 4, "5" = 5, "6" = 6, "Very true of me" = 7)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(narcissism),
            add_likert_narcissism)

# Stress
add_likert_stress <- function(x) {
  val_labels(x) <- c("Never" = 0, "Almost never" = 1, "Sometimes" = 2,
                     "Fairly often" = 3, "Very often" = 4)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(stress1:stress10),
            add_likert_stress)

# CESD
add_likert_CESD_short <- function(x) {
  val_labels(x) <- c("Rarely or none of the time" = 0,
                     "Some or a little of the time" = 1,
                     "Occasionally or a moderate amount of time" = 2,
                     "Most or all of the time" = 3)
  return(x)
}
RAIv1_public <- RAIv1_public %>%
  mutate_at(vars(CESD1:CESD10),
            add_likert_CESD_short)


```

## Reverse Coding Values

```{r RAIv1 Reverse-Code Values}
# Recoding
## PROMIS SCALES, No Recoding Needed for Isolation, Emotional, Informational Support
## Couples Satisfaction Index - no recoding needed
## Partner Responsiveness - no recoding needed
## Relationship Conflict Scale - no recoding needed (higher scores = more conflict)
## Ostracism from Romantic Partner Scale
### Items 6, 7, 8, 9, 10, higher scores mean less ostracism
ostracism_rev <- c(6, 7, 8, 9, 10)
ostracism_rev_vars <- paste0("ostracism", ostracism_rev)
ostracism_nonrev <- (1:10)[!(1:10 %in% ostracism_rev)]
ostracism_nonrev_vars <- paste0("ostracism", ostracism_nonrev)
ostracism_vars <- c(ostracism_nonrev_vars, paste0(ostracism_rev_vars, "R"))
### Add "R" to reversed variable names
RAIv1_public <- RAIv1_public %>% 
  rename_at(ostracism_rev_vars, add_R)
## Reverse the values of the reversed variables with "R"
RAIv1_public <- RAIv1_public %>%
  mutate_at(paste0(ostracism_rev_vars, "R"), reverse_labelled_values)

# Abusive Behavior Inventory - No Recoding Needed
# Control Behavior Scale - No Recoding Needed 
# Food Craving - No Recording Needed
# Dietary Social Support - For Items 6, 7 are unsupportive behavior


# Dietary Social Support - Reverse Items 6, 7 are unsupportive behavior
dietary_support_rev <- c(6, 7)
dietary_support_rev_vars <- paste0("dietary_support", dietary_support_rev)
dietary_support_nonrev <- setdiff(1:9, dietary_support_rev)
dietary_support_nonrev_vars <- paste0("dietary_support", dietary_support_nonrev)
dietary_support_vars <- c(dietary_support_nonrev_vars,
                          paste0(dietary_support_rev_vars, "R"))
## Add "R" to reversed variable names
RAIv1_public <- RAIv1_public %>% 
  rename_at(dietary_support_rev_vars, add_R)
## Reverse the values of the reversed variables with "R"
RAIv1_public <- RAIv1_public %>%
  mutate_at(paste0(dietary_support_rev_vars, "R"), reverse_labelled_values)

# Body Image - No Recording Needed 

# Godin Leisure-Time Exercise Questionnaire - Values need to be updated but no recoding

# PROMIS Sleep Disturbance - No recording needed http://www.healthmeasures.net/images/promis/manuals/PROMIS_Sleep_Disturbance_Scoring_Manual.pdf

# Single-Item Narcissism - no recording 

# Perceived Stress Scale - 4, 5, 7, 8 are reversed
stress_rev <- c(4, 5, 7, 8)
stress_rev_vars <- paste0("stress", stress_rev)
stress_nonrev <- setdiff(1:10, stress_rev)
stress_nonrev_vars <- paste0("stress", stress_nonrev)
stress_vars <- c(stress_nonrev_vars, paste0(stress_rev_vars, "R"))
## Add "R" to reversed variable names
RAIv1_public <- RAIv1_public %>% 
  rename_at(stress_rev_vars, add_R)
## Reverse the values of the reversed variables with "R"
RAIv1_public <- RAIv1_public %>%
  mutate_at(paste0(stress_rev_vars, "R"), reverse_labelled_values)


# CESD - Short-Form - Items 5 & 8 are reversed
CESD_short_rev <- c(5, 8)
CESD_short_rev_vars <- paste0("CESD", CESD_short_rev)
CESD_short_nonrev <- setdiff(1:10, CESD_short_rev)
CESD_short_nonrev_vars <- paste0("CESD", CESD_short_nonrev)
CESD_short_vars <- c(CESD_short_nonrev_vars, paste0(CESD_short_rev_vars, "R"))
## Add "R" to reversed variable names
RAIv1_public <- RAIv1_public %>% 
  rename_at(CESD_short_rev_vars, add_R)
## Reverse the values of the reversed variables with "R"
RAIv1_public <- RAIv1_public %>%
  mutate_at(paste0(CESD_short_rev_vars, "R"), reverse_labelled_values)
```

### Updating the Exercise Variables

-   Some participants provided non-numeric answers to exercise questions

-   Rules for coding

-   if the participant provides a numeric answer with a symbol, I will take the numeric answer

-   if the participant provides an interval answer (e.g., 5-7), I will take the lower number

-   some values included dates (e.g., May-7). I assumed that these answers were originally provided as two numeric values with a hyphen or a slash (e.g., 5/7 or 5-7)

```{r}
# Exercise Updates
# Look for People with Non-Numeric Answers
exercise_updates_needed <-RAIv1_public %>%
  filter(is.na(as.numeric(exercise1)) | 
           is.na(as.numeric(exercise2) |
                   is.na(as.numeric(exercise3) | 
                           is.na(as.numeric(exercise4))))) %>%
  select(id, visit, starts_with("exercise"))
exercise_updates_needed %>% 
  arrange(id, visit)
```

```{r Updating Exercise Variables}
# Exercise 1 Item
# Participant 310, Visit 2 - original answer: 7+
RAIv1_public[RAIv1_public$id == 310 & RAIv1_public$visit == 2, ]$exercise1 <- "7" 

# Participant 318, Visit 3 - original answer: 7-May (presumably converted from 5-7) 
RAIv1_public[RAIv1_public$id == 318 & RAIv1_public$visit == 3, ]$exercise1 <- "5"

# Participant 318, Visit 2 - original answer: 7-Jun (presumably converted from 6-7) 
RAIv1_public[RAIv1_public$id == 318 & RAIv1_public$visit == 2, ]$exercise1 <- "6"

# Participant 385, Visit 1 - original answer: 3-Feb	 (presumably converted from 2-3) 
RAIv1_public[RAIv1_public$id == 385 & RAIv1_public$visit == 1, ]$exercise1 <- "2"

# Participant 309, Visit 2 - original answer: 3-Feb	 (presumably converted from 2-3) 
RAIv1_public[RAIv1_public$id == 309 & RAIv1_public$visit == 2, ]$exercise1 <- "2"

# Participant 418, Visit 1 - original answer: 2-Jan	 (presumably converted from 1-2) 
RAIv1_public[RAIv1_public$id == 418 & RAIv1_public$visit == 1, ]$exercise1 <- "1"

# Participant 404	1	0h, Visit 1 - original answer: 0h
RAIv1_public[RAIv1_public$id == 404 & RAIv1_public$visit == 1, ]$exercise1 <- "0"

# Exercise 2 Item
## Participant 310, Visit 1 - original answer: 0? 
RAIv1_public[RAIv1_public$id == 310 & RAIv1_public$visit == 2, ]$exercise2 <- "0"

## Participant 318, Visit 2 - original answer: 10+
RAIv1_public[RAIv1_public$id == 318 & RAIv1_public$visit == 2, ]$exercise2 <- "10"

## Participant 385, Visit 1 - original answer: 3-Feb	 (presumably converted from 2-3) 
RAIv1_public[RAIv1_public$id == 385 & RAIv1_public$visit == 1, ]$exercise2 <- "2"

## Participant 414, Visit 3 - original answer: 3-Jan	 (presumably converted from 1-3) 
RAIv1_public[RAIv1_public$id == 414 & RAIv1_public$visit == 3, ]$exercise2 <- "1"

## Participant 404, Visit 1 - original answer: 3h (converted to 6 (15 min. x 6 = 3h)) 
RAIv1_public[RAIv1_public$id == 404 & RAIv1_public$visit == 1, ]$exercise2 <- "6"

## Participant 320, Visit 1 - original answer: 5-Apr	 (presumably converted from 4-5) 
RAIv1_public[RAIv1_public$id == 320 & RAIv1_public$visit == 1, ]$exercise2 <- "4"

# Exercise 3 Item
## Participant 310, Visit 1 - original answer: 2?
RAIv1_public[RAIv1_public$id == 310 & RAIv1_public$visit == 1, ]$exercise3 <- "2"

## Participant 318, Visit 2 - original answer: 15+
RAIv1_public[RAIv1_public$id == 318 & RAIv1_public$visit == 2, ]$exercise3 <- "15"

## Participant 404, Visit 1 - original answer: 4h (15 mins x 8 = 4h) 
RAIv1_public[RAIv1_public$id == 404 & RAIv1_public$visit == 1, ]$exercise3 <- "8"
```

```{r Checking the Recode}
RAIv1_public %>% 
  select(id, visit, starts_with("exercise")) %>% 
  left_join(exercise_updates_needed, by = c("id", "visit")) %>% 
  drop_na() %>%
  arrange(id, visit)
```

```{r Study1b-Exercise-To-Numeric}
# Convert exercise items to numeric
RAIv1_public <- RAIv1_public %>% 
  mutate(across(starts_with("exercise"),
                function(x){x = x}, .names = "raw_{col}"),
         across(starts_with("exercise"),
                ~as.numeric(.))
  )
```

## Calculate Scale Scores

```{r}
## Indices Calculations

# PROMIS Social Isolation - Sum
RAIv1_public$PROMIS_isolation_sum <- RAIv1_public %>% 
  select(PROMIS_isolation1:PROMIS_isolation8) %>%
  aggregate_and_document_scale(fun = rowSums)

# PROMIS - Emotional Support - Sum
RAIv1_public$PROMIS_emotional_sum <- RAIv1_public %>% 
  select(PROMIS_emotional1:PROMIS_emotional8) %>%
  aggregate_and_document_scale(fun = rowSums)

# PROMIS - Informational Support - Sum
RAIv1_public$PROMIS_informational_sum <- RAIv1_public %>% 
  select(PROMIS_informational1:PROMIS_informational8) %>%
  aggregate_and_document_scale(fun = rowSums)

# Couples Satisfaction Index - Mean
RAIv1_public$couples_satisfaction_mean <- RAIv1_public %>% 
  select(couples_satisfaction1:couples_satisfaction4) %>%
  aggregate_and_document_scale()

# Partner Responsiveness - Mean
RAIv1_public$partner_resp_mean <- RAIv1_public %>% 
  select(partner_resp1:partner_resp3) %>%
  aggregate_and_document_scale()

# Relationship Conflict Scale - Mean
RAIv1_public$conflict_mean <- RAIv1_public %>% 
  select(conflict1:conflict3) %>%
  aggregate_and_document_scale()

# Relationship Conflict Scale - Mean
RAIv1_public$ostracism_mean <- RAIv1_public %>% 
  select(all_of(ostracism_vars)) %>%
  aggregate_and_document_scale()

# Abusive Behavior Inventory - Psychological - Mean
RAIv1_public$abuse_psychological_mean <- RAIv1_public %>% 
  select(abuse_psychological1:abuse_psychological12) %>%
  aggregate_and_document_scale()

# Abusive Behavior Inventory - Physical - Mean
RAIv1_public$abuse_physical_mean <- RAIv1_public %>% 
  select(abuse_physical1:abuse_physical11) %>%
  aggregate_and_document_scale()

# Abusive Behavior Inventory - Economic - Mean
RAIv1_public$control_economic_mean <- RAIv1_public %>% 
  select(control_economic1:control_economic4) %>%
  aggregate_and_document_scale()

# Controlling Behavior Scale - Threats - Mean
RAIv1_public$control_threats_mean <- RAIv1_public %>% 
  select(control_threats1:control_threats4) %>%
  aggregate_and_document_scale()

# Controlling Behavior Scale - Threats - Mean
RAIv1_public$control_intimidation_mean <- RAIv1_public %>% 
  select(control_intimidation1:control_intimidation5) %>%
  aggregate_and_document_scale()

# Controlling Behavior Scale - Emotional - Mean
RAIv1_public$control_emotional_mean <- RAIv1_public %>% 
  select(control_emotional1:control_emotional5) %>%
  aggregate_and_document_scale()

# Controlling Behavior Scale - Isolation - Mean
RAIv1_public$control_isolation_mean <- RAIv1_public %>% 
  select(control_isolation1:control_isolation6) %>%
  aggregate_and_document_scale()

# Food Cravings - Having intentions and plans to consume food (3 items) - Mean
RAIv1_public$craving_intent <- RAIv1_public %>% 
  select(food_craving5, food_craving10, food_craving13) %>%
  aggregate_and_document_scale()

# Food Cravings - Lack of control over eating (6 items) - Mean
RAIv1_public$craving_control <- RAIv1_public %>% 
  select(food_craving2, food_craving3,
         food_craving12, food_craving14,
         food_craving15, food_craving18) %>%
  aggregate_and_document_scale()

# Food Cravings - Lack of control over eating (6 items) - Mean
RAIv1_public$craving_thoughts <- RAIv1_public %>% 
  select(food_craving6, food_craving8, food_craving16,
         food_craving17, food_craving20, food_craving21,
         food_craving22) %>%
  aggregate_and_document_scale()

# Food Cravings - Emotions (4 items) Mean
RAIv1_public$craving_emotions <- RAIv1_public %>% 
  select(food_craving11, food_craving19,
         food_craving23, food_craving27) %>%
  aggregate_and_document_scale()

# Food Cravings - Cues that may trigger food cravings (4 Items 1, 24, 25, 26) -  Mean
RAIv1_public$craving_cues <- RAIv1_public %>% 
  select(food_craving1, food_craving24, food_craving25, food_craving26) %>%
  aggregate_and_document_scale()

# Food Cravings - Guilt (3 items) -  Mean
RAIv1_public$craving_guilt <- RAIv1_public %>% 
  select(food_craving4, food_craving7, food_craving9) %>%
  aggregate_and_document_scale()

# Food Cravings - Overall - Mean
RAIv1_public$craving_mean<- RAIv1_public %>% 
  select(food_craving1:food_craving27) %>%
  aggregate_and_document_scale()


# Dietary Support Scale - Reverse Coded Items -  Mean
RAIv1_public$dietary_support_mean <- RAIv1_public %>% 
  select(all_of(dietary_support_vars)) %>%
  aggregate_and_document_scale()

# Godin-Shephard Leisure-Time Questionnaire -  Formula
RAIv1_public <- RAIv1_public %>% 
  mutate(exercise_godin = (9 * exercise1) + (5 * exercise2) + (3 * exercise3))

# PROMIS - Sleep -  Sum
# Different Question Labels - Strip labels first and calculate aggregate
RAIv1_public <- RAIv1_public %>%
  mutate(across(sleep1:sleep4, list(nolabel = ~as.numeric(.))))
RAIv1_public$sleep_sum <- RAIv1_public %>% 
  select(sleep1_nolabel:sleep4_nolabel) %>%
  aggregate_and_document_scale(fun = rowSums)

# CESD - Short -  Sum
RAIv1_public$CESD_sum <- RAIv1_public %>% 
  select(all_of(CESD_short_vars)) %>%
  aggregate_and_document_scale()

# Perceived Stress Scale - Mean
RAIv1_public$stress_mean <- RAIv1_public %>% 
  select(all_of(stress_vars)) %>%
  aggregate_and_document_scale()
```

```{r s1b-saving-reliabilities}
# save reliability object for caching
s1b_reliability_data <- RAIv1_public %>% 
  compute_reliabilities() %>% get_reliability_output()
# compress and save (otherwise 5GB < file size)
s1b_reliability_data %>% 
  write_rds(here("data_public", "reliability", "s1b_reliability.rds"), compress = "gz")
```

## Save the Public Dataset

```{r}
write_csv(RAIv1_public, here("data_public/Study1b_public.csv"))
write_rds(RAIv1_public, here("data_public/Study1b_public.rds"))
```

------------------------------------------------------------------------

# Study 1c - ARv1

## Load Data and Select Variables

```{r}
# Load Dataset - Qualtrics csv
ARv1_raw <- read_csv(here("data/ARv1/ARv1_MTurk_cleaned.csv"), col_types = cols())
ARv1_raw_vars <- ARv1_raw %>% slice(1) %>% t() %>% tibble("var" = names(ARv1_raw), "label" = .) 
ARv1_raw <- ARv1_raw %>% slice(-1)
# Assign arbitrary participant ID 
ARv1_raw <- ARv1_raw %>% mutate(id = row_number())
# Peek at the data
ARv1_public_vars <- list(
  # ID
  id = "id",
  # Finished Status
  finished = "Finished",
  # Rejection Condition
  acceptance = "SocialExp",
  # Closeness Condition
  closeness = "Closeness",
  # Age
  age = "Age",
  sex = "Sex",
  race = "Race",
  # Memory
  target_age = "MemoryPersonCurrentAge",
  target_sex = "MemoryPersonSex",
  target_race = "MemoryPersonRace",
  # Manikins
  heart1 = "Q9", # Heart Manikin 1
  heart2 = "Q27",
  heart3 = "Q43",
  valence1 = "Q8", # Valence Manikin 1
  valence2 = "Q24", # Valence Manikin 2
  valence3 = "Q42", # Valence Manikin 3
  arousal2 = "Q25", # Arousal - Time 2
  dominance2 = "Q26", # Domiance - Time 2
  # # Need-Threat Scales - Calculated Variables
  # nts_belonging_mean = "AvgBelonging", # Need-Threat 
  # nts_esteem_mean = "AvgSelfEsteem",
  # nts_control_mean = "AvgControl",
  # nts_meaning_mean = "AvgMeaningfulExs",
  # nts_identitiy_mean = "AvgSelfIdentity",
  # Need-Threat Scales - Individual Items
  nts_belonging1 = "Rejected",
  nts_belonging2 = "Disconnected",
  nts_belonging3 = "Isolated",
  nts_belonging4 = "Accepted",
  nts_esteem1 = "Q20_4",
  nts_esteem2 = "Q20_5",
  nts_esteem3 = "Q20_6",
  nts_control1 = "Q20_1",
  nts_control2 = "Q20_2",
  nts_control3 = "Q20_3",
  nts_meaning1 = "Q19_4",
  nts_meaning2 = "Q19_5", # How important did you feel
  nts_meaning3 = "Q19_6",
  nts_identity1 = "Q21_1",
  nts_identity2 = "Q21_2",
  nts_identity3 = "Q21_3",
  # Subjective Social Status
  ladder = "Ladder"
)


# Select out the public variables
ARv1_public <- ARv1_raw %>%
  select(unlist(ARv1_public_vars))

# Convert all to numeric
ARv1_public <- ARv1_public %>%
  mutate(across(c(age, target_age, heart1:ladder),
                as.numeric))

# Only include particiaptns aged 18-120
ARv1_public <- ARv1_public %>%
  filter(age >= 18,
         age <= 120)
```

## Recode Values & Labels

```{r ARv1 Recode Values}
# Read SPSS file and save the labels
ARv1_vars <- ARv1_public %>% colnames() %>% tibble(var = .)
write_excel_csv(ARv1_vars, here("codebooks/ARv1_vars.csv"))

# Read the dictionary from Web
ARv1_dict_URL <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vSSKf5d77gUNhowkXMnavRW-Qc4sNl-s4IH6WVQVZeyT7Yae1T-hwsyk-Y5rx0RyRnz8mqhyutlqcuj/pub?gid=0&single=true&output=csv"

# Read the variable dictionary google sheet
ARv1_dict <- read_csv(ARv1_dict_URL, col_types = cols())
# Set the variable labels
var_label(ARv1_public) <- ARv1_dict %>% 
  select(varname, label) %>% 
  dict_to_list()

## Set Value Labels
# Hearts
ARv1_public <- ARv1_public %>%
  mutate_at(vars(starts_with("heart")),
            add_labels_heart)

# Valence
ARv1_public <- ARv1_public %>%
  mutate_at(vars(starts_with("valence")),
            add_labels_valence)

# Arousal
add_labels_arousal <- function(x) {
  val_labels(x) <- c("relaxed, calm, sleepy, sluggish" = 1, "2" = 2,
                     "3" = 3, "4" = 4, "5" = 5, "6" = 6, "7" = 7, "8" = 8,
                     "excited, frenzied, wide-awake, aroused" = 9)
  return(x)
}
ARv1_public <- ARv1_public %>%
  mutate_at(vars(starts_with("arousal")),
            add_labels_arousal)


# Dominance
add_labels_dominance <- function(x) {
  val_labels(x) <- c("submissive, influenced, controlled by others" = 1, "2" = 2,
                     "3" = 3, "4" = 4, "5" = 5, "6" = 6, "7" = 7, "8" = 8,
                     "in control, important, dominant, autonomous" = 9)
  return(x)
}
ARv1_public <- ARv1_public %>%
  mutate_at("dominance2",
            add_labels_dominance)


# Experimental Variables - Acceptance/Rejection
add_labels_acceptance <- function(x) {
  val_labels(x) <- c("Acceptance" = "1",
                     "Rejection" = "0")
  return(x)
}
ARv1_public <- ARv1_public %>%
  mutate_at("acceptance",
            add_labels_acceptance)

#  Experimental Variables - Closeness
add_labels_closeness <- function(x) {
  val_labels(x) <- c("Distant Other" = "0",
                     "Close Other" = "1")
  return(x)
}
ARv1_public <- ARv1_public %>% 
    mutate_at("closeness",
            add_labels_closeness)

# Demographics
# Sex
add_labels_sex_m1f2 <- function(x) {
  val_labels(x) <- c("Male" = "1",
                     "Female" = "2")
  return(x)
}
ARv1_public <- ARv1_public %>% 
    mutate_at(c("sex", "target_sex"), add_labels_sex_m1f2)


# Race 
add_labels_race_1w7o <- function(x) {
  val_labels(x) <- c("White" = "1",
                     "Black" = "2",
                     "Asian" = "3",
                     "Hispanic" = "4",
                     "Native American" = "5",
                     "Bi-Racial or Multi-Racial" = "6",
                     "Other" = "7")
  return(x)
}
ARv1_public <- ARv1_public %>% 
    mutate_at(c("race", "target_race"), add_labels_race_1w7o)



ARv1_public <- ARv1_public %>% 
    mutate_at(vars(starts_with("nts")), add_labels_nts)

```

## Reverse Coding

```{r ARv1 Reverse-Code Values}
# Need-Threat Scale
nts_belonging_vars <- c("nts_belonging1R", "nts_belonging2R", "nts_belonging3R",
                        "nts_belonging4")
nts_esteem_vars <- c("nts_esteem1R", "nts_esteem2", "nts_esteem3")
nts_control_vars <- c("nts_control1", "nts_control2", "nts_control3")
nts_meaning_vars <- c("nts_meaning1R", "nts_meaning2", "nts_meaning3R")

nts_rev_vars <- c("nts_belonging1", "nts_belonging2", "nts_belonging3",
                  "nts_esteem1",
                  "nts_meaning1", "nts_meaning3")
nts_nonrev_vars <- c("nts_belonging4",
                     "nts_esteem2", "nts_esteem3",
                     "nts_control1", "nts_control2", "nts_control3",
                     "nts_meaning2")
nts_vars <- c(nts_nonrev_vars, paste0(nts_rev_vars, "R"))
# Reverse Code the Sliders
ARv1_public <- ARv1_public %>%
  mutate(across(all_of(nts_rev_vars),
                .fns = function(x){100 - x},
                .names = "{col}R"))
```

## Calculate Scales

```{r ARv1 Scale Calculation}
# Manikins - No Scale Calculations Needed 

# NTS - Belonging - Mean
ARv1_public$nts_belonging_mean <- ARv1_public %>%
  select(all_of(nts_belonging_vars)) %>%
  aggregate_and_document_scale()

# NTS - Self-Esteem - Mean
ARv1_public$nts_esteem_mean <- ARv1_public %>%
  select(all_of(nts_esteem_vars)) %>%
  aggregate_and_document_scale()

# NTS - Control - Mean
ARv1_public$nts_control_mean <- ARv1_public %>%
  select(all_of(nts_control_vars)) %>%
  aggregate_and_document_scale()

# NTS - Meaning - Mean
ARv1_public$nts_meaning_mean <- ARv1_public %>%
  select(all_of(nts_meaning_vars)) %>%
  aggregate_and_document_scale()

# NTS - Overall - Mean
ARv1_public$nts_mean <- ARv1_public %>%
  select(all_of(nts_vars)) %>%
  aggregate_and_document_scale()

```

```{r s1c-saving-reliabilities}
# save reliability object for caching
s1c_reliability_data <- ARv1_public %>% 
  compute_reliabilities() %>% get_reliability_output()
# compress and save (otherwise 5GB < file size)
s1c_reliability_data %>% 
  write_rds(here("data_public", "reliability", "s1c_reliability.rds"), compress = "gz")
```
## Save the Public Dataset

```{r ARv1 SAve}
# .csv
write_csv(ARv1_public, here("data_public/Study1c_public.csv"))
# .rds
write_rds(ARv1_public, here("data_public/Study1c_public.rds"))
```

------------------------------------------------------------------------

# Study 1d - EVv1

## Load Data and Select Variables

```{r}
# Load Dataset
EVv1_raw <- read_rds(here("data/EVv1/Qualtrics_Main_Scale_Computed.rds"))

# List of Variables Needed
EVv1_vars <- list(
  id = "fleenID",
  StartDate = "StartDate",
  EndDate = "EndDate",
  # Confederate Desire Condition (Expectancy)
  expectancy = "Expectancy Condition",
  # Rejection Condition 
  rejection = "Rejection Condition",
  # Age
  age = "demo_age",
  # Race
  race_native_american = "demo_race_1",
  race_african_american = "demo_race_2", 
  race_white_caucasian = "demo_race_3",
  race_asian_pacific_islander = "demo_race_4",
  race_self_describe = "demo_race_5",
  race_self_describe_text = "demo_race_5_TEXT",
  # Hispanic
  hispanic = "demo_latino",
  # Gender 
  gender_male = "demo_gender_1",
  gender_female = "demo_gender_2",
  gender_trans_mtf = "demo_gender_3",
  gender_trans_ftm = "demo_gender_4",
  gender_trans_noid = "demo_gender_5",
  gender_unsure = "demo_gender_6",
  gender_self_describe = "demo_gender_7",
  gender_self_describe_text = "demo_gender_7_TEXT",
  # Sexual Orientation
  orientation = "demo_sex_orientation",
  # Scales
  # Heart Manikin
  heart_T = paste0("manikin_", 1:4, "_heart"),
  # Self-Assessment Manikin - Valence
  valence_T = paste0("manikin_", 1:4, "_valence"),
  arousal_T = paste0("manikin_", 1:4, "_arousal"),
  dominance_T = paste0("manikin_", 1:4, "_dominance"),
  # Rosenberg Self-Esteem Scale - the original dataset includes the reverse coded items (3, 5, 8, 9, 10)
  esteem = paste0("RSE_", 1:10),
  # Need for Closure - No reverse coding
  closure = paste0("nfc_", 1:15),
  closure_mean = "nfc",
  # Modified NTS
  nts_T3_ = paste0("NTSmod_1_", 1:13),
  nts_T4_ = paste0("NTSmod_2_", 1:13),
  # Social Judgment Survey - Bond Allocation
  SJS_bond = "SJS"
)

# Select out the public variables 
EVv1_public <- EVv1_raw %>%
  select(unlist(EVv1_vars))

# Convert to Factors and Values to String
EVv1_public <- EVv1_public %>% 
  mutate(across(race_native_american:orientation, to_factor))
```

## Edit Variable Labels

```{r}
# Date
EVv1_public <- EVv1_public %>%
  mutate(across(c(StartDate, EndDate),
                lubridate::as_datetime))


# Write out colnames to a .csv to be exported to Google Sheet
EVv1_public %>% colnames() %>%
  tibble(varname = .) %>%
  write_excel_csv(here("codebooks/EVv1_vars.csv"))

# Read the dictionary from Web
EVv1_dict_URL <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTtjXKdBkHc9T2SD9vKRfBwJCu_L8-Onr8rOytyQu2jUiYnn0FgXNyFhAf7IY7rdj97flrAxOcouwPe/pub?gid=0&single=true&output=csv"

# Read the variable dictionary google sheet
EVv1_dict <- read_csv(EVv1_dict_URL, col_types = cols())
# Set the variable labels
var_label(EVv1_public) <- EVv1_dict %>% 
  select(varname, label) %>% 
  dict_to_list()
```

## Edit Value Labels

```{r}
# Heart 
add_labels_heart <- function(x) {
  val_labels(x) <- c("lonely, rejected, isolated, disconnected" = 1, "2" = 2,
                     "3" = 3, "4" = 4, "5" = 5, "6" = 6, "7" = 7, "8" = 8,
                     "cared for, accepted, loved, connected" = 9)
  return(x)
}
EVv1_public <- EVv1_public %>%
  mutate_at(vars(starts_with("heart")),
            add_labels_heart)

# Valence
add_labels_valence <- function(x) {
  val_labels(x) <- c("unhappy, annoyed, unsatisfied, bored" = 1, "2" = 2,
                     "3" = 3, "4" = 4, "5" = 5, "6" = 6, "7" = 7, "8" = 8,
                     "happy, pleased, satisfied, hopeful" = 9)
  return(x)
}
EVv1_public <- EVv1_public %>%
  mutate_at(vars(starts_with("valence")),
            add_labels_valence)

# Arousal
add_labels_arousal <- function(x) {
  val_labels(x) <- c("relaxed, calm, sleepy, sluggish" = 1, "2" = 2,
                     "3" = 3, "4" = 4, "5" = 5, "6" = 6, "7" = 7, "8" = 8,
                     "excited, frenzied, wide-awake, aroused" = 9)
  return(x)
}
EVv1_public <- EVv1_public %>%
  mutate_at(vars(starts_with("arousal")),
            add_labels_arousal)

# Dominance
add_labels_dominance <- function(x) {
  val_labels(x) <- c("submissive, influenced, controlled by others" = 1, "2" = 2,
                     "3" = 3, "4" = 4, "5" = 5, "6" = 6, "7" = 7, "8" = 8,
                     "in control, important, dominant, autonomous" = 9)
  return(x)
}
EVv1_public <- EVv1_public %>%
  mutate_at(vars(starts_with("dominance")),
            add_labels_dominance)

# Self-Esteem
esteem_rev_vars <- c("esteem3", "esteem5", "esteem8", 
                     "esteem9", "esteem10")
esteem_nonrev_vars <- setdiff(paste0("esteem", 1:10), esteem_rev_vars)
esteem_vars <- c(esteem_nonrev_vars, paste0(esteem_rev_vars, "R"))

add_labels_esteem <- function(x) {
  val_labels(x) <- c("strongly disagree" = -3, "disagree" = -2,
                     "slightly disagree" = -1, "neither disagree or agree" = 0,
                     "slightly agree" = 1, "agree" = 2, "strongly agree" = 3)
  return(x)
}
EVv1_public <- EVv1_public %>%
  mutate_at(vars(esteem1:esteem10),
            add_labels_esteem)

# Need for Closure
add_labels_closure <- function(x) {
  val_labels(x) <- c("strongly disagree" = -3, "disagree" = -2,
                     "slightly disagree" = -1, "neither disagree or agree" = 0,
                     "slightly agree" = 1, "agree" = 2, "strongly agree" = 3)
  return(x)
}
EVv1_public <- EVv1_public %>%
  mutate_at(vars(closure1:closure15),
            add_labels_esteem)

# Modified Need-Threat Scale
add_labels_nts <- function(x) {
  val_labels(x) <- c("The least I could ever possibly feel" = 0,
                     "The most I could ever possibly feel" = 100)
  return(x)
}
EVv1_public <- EVv1_public %>%
  mutate_at(vars(nts_T3_1:nts_T4_13),
            add_labels_nts)

```

## Reverse Coding

```{r}
# Reverse Coding

# Self-Esteem - (Items 3, 5, 8, 9, 10)
## Add "R" to reversed variable names
EVv1_public <- EVv1_public %>% 
  rename_at(esteem_rev_vars, add_R)
## Reverse the values of the reversed variables with "R"
EVv1_public <- EVv1_public %>% 
  mutate_at(paste0(esteem_rev_vars, "R"), reverse_labelled_values)

# Modified Need-Threat Scale - (Reverse code items 1, 2, 3, 5, 7, 11)
EVv1_nts_rev_vars <- paste0("nts_T", rep(3:4, each = 6), "_", c(1, 2, 3, 5, 7, 11))
EVv1_nts_nonrev_vars <- setdiff(paste0("nts_T", rep(3:4, each = 13), "_", 1:13),
                                EVv1_nts_rev_vars)
EVv1_nts_vars <- c(EVv1_nts_rev_vars, EVv1_nts_nonrev_vars)

## Add "R" to reversed variable names
EVv1_public <- EVv1_public %>% 
  rename_at(EVv1_nts_rev_vars, add_R)
## Reverse the values of the reversed variables with "R"
EVv1_public <- EVv1_public %>% 
  mutate_at(paste0(EVv1_nts_rev_vars, "R"), reverse_labelled_values)
```

## Calculate Scales

```{r}
# Manikins - No Calculations Needed

# Rosenberg Self-Esteem Scale - Mean
EVv1_public$esteem_mean <- EVv1_public %>%
  select(all_of(esteem_vars)) %>%
  aggregate_and_document_scale()

# Need for Closure - Mean
EVv1_public$closure_mean <- EVv1_public %>%
  select(closure1:closure15) %>%
  aggregate_and_document_scale()


# Need-Threat Scale (Times 3 & 4)
# NTS Belonging Time 3 - Mean
EVv1_public$nts_belonging_T3_mean <- EVv1_public %>%
  select(all_of(c("nts_T3_1R", "nts_T3_2R",
                  "nts_T3_3R", "nts_T3_4"))) %>%
  aggregate_and_document_scale()

# NTS Self-Esteem Time 3 - Mean
EVv1_public$nts_esteem_T3_mean <- EVv1_public %>%
  select(all_of(c("nts_T3_11R", "nts_T3_12", "nts_T3_13"))) %>%
  aggregate_and_document_scale()

# NTS Control Time 3 - Mean
EVv1_public$nts_control_T3_mean <- EVv1_public %>%
  select(all_of(c("nts_T3_8", "nts_T3_9", "nts_T3_10"))) %>%
  aggregate_and_document_scale()

# NTS Meaning Time 3 - Mean
EVv1_public$nts_meaning_T3_mean <- EVv1_public %>%
  select(all_of(c("nts_T3_5R", "nts_T3_6", "nts_T3_7R"))) %>%
  aggregate_and_document_scale()

# NTS Overall Time 3 - Mean
EVv1_public$nts_T3_mean <- EVv1_public %>%
  select(all_of(c(
    "nts_T3_11R", "nts_T3_12",  "nts_T3_13",
    "nts_T3_8", "nts_T3_9", "nts_T3_10",
    "nts_T3_5R", "nts_T3_6", "nts_T3_7R"
  ))) %>%
  aggregate_and_document_scale()


# NTS Time 4
# NTS Belonging Time 4 - Mean
EVv1_public$nts_belonging_T4_mean <- EVv1_public %>%
  select(all_of(c("nts_T4_1R", "nts_T4_2R",
                  "nts_T4_3R", "nts_T4_4"))) %>%
  aggregate_and_document_scale()

# NTS Self-Esteem Time 4 - Mean
EVv1_public$nts_esteem_T4_mean <- EVv1_public %>%
  select(all_of(c("nts_T4_11R", "nts_T4_12", "nts_T4_13"))) %>%
  aggregate_and_document_scale()

# NTS Control Time 4 - Mean
EVv1_public$nts_control_T4_mean <- EVv1_public %>%
  select(all_of(c("nts_T4_8", "nts_T4_9", "nts_T4_10"))) %>%
  aggregate_and_document_scale()

# NTS Meaning Time 4 - Mean
EVv1_public$nts_meaning_T4_mean <- EVv1_public %>%
  select(all_of(c("nts_T4_5R", "nts_T4_6", "nts_T4_7R"))) %>%
  aggregate_and_document_scale()

# NTS Overall Time 4 - Mean
EVv1_public$nts_T4_mean <- EVv1_public %>%
  select(all_of(c(
    "nts_T4_1R", "nts_T4_2R",
    "nts_T4_3R", "nts_T4_4",
    "nts_T4_11R", "nts_T4_12", "nts_T4_13",
    "nts_T4_8", "nts_T4_9", "nts_T4_10",
    "nts_T4_5R", "nts_T4_6", "nts_T4_7R"
  ))) %>%
  aggregate_and_document_scale()

```

```{r s1d-saving-reliabilities}
# save reliability object for caching
s1d_reliability_data <- compute_reliabilities(EVv1_public) %>% get_reliability_output()
# compress and save (otherwise 5GB < file size)
write_rds(s1d_reliability_data, here("data_public", "reliability", "s1d_reliability.rds"), compress = "gz")
```

## Save the Public Dataset

```{r}
# .csv
write_csv(EVv1_public, here("data_public/Study1d_public.csv"))
# .rds
write_rds(EVv1_public, here("data_public/Study1d_public.rds"))

```

------------------------------------------------------------------------

# Study 1e - NPSv2

## Load Data and Select Variables

```{r}
# Load Data
NPSv2_raw <- read_rds(here("data/NPSv2/merged_compnaivewhite.rds"))

NPSv2_vars <- list(
  # Dates
  StartDate_D1 = "StartDate",
  EndDate_D1 = "EndDate",
  ## Day 2
  StartDate_D2 = "StartDate_D2",
  EndDate_D2 = "EndDate_D2",
  # Participant ID 
  id = "fleen",
  # Conditions
  rejection = "rejection",
  participant_desire = "compatibility",
  confederate_desire = "liking",
  # Age
  age = "age",
  # Race
  race = "race",
  race_text = "race_5_TEXT",
  hispanic = "latino",
  native_english = "nativeEnglish",
  english_years = "englishHowLong",
  # Gender
  gender = "gender",
  # Heart Manikin
  heart_T1 = "heart1",
  heart_T2 = "heart2",
  heart_T3 = "heart3",
  heart_T4 = "manikinD21Heart",
  heart_T5 = "manikinD22Heart",
  heart_T6 = "manikinD23Heart",
  # Manikin - Valence
  valence_T1 = "valence1",
  valence_T2 = "valence2",
  valence_T3 = "valence3",
  valence_T4 = "manikinD21Valence1",
  valence_T5 = "manikinD22Valence",
  valence_T6 = "manikinD23Valence",
  # Manikin - Arousal
  arousal_T1 = "arousal1",
  arousal_T2 = "arousal2",
  arousal_T3 = "arousal3",
  arousal_T4 = "manikinD21Arousal",
  arousal_T5 = "manikinD22Arousal",
  arousal_T6 = "manikinD23Arousal",
  # Manikin - Dominance
  dominance_T1 = "dominance1",
  dominance_T2 = "dominance2",
  dominance_T3 = "dominance3",
  dominance_T4 = "manikinD21Dominance",
  dominance_T5 = "manikinD22Dominance",
  dominance_T6 = "manikinD23Domiance", # Typo in the original dataset
  # Experience in Close Relationship Scale - Reversed Items: 1, 5, 8, 9
  ECR = paste0("mECR_mECR_", 1:12),
  # ECR1_rev = "mECR_mECR_1R",
  # ECR5_rev = "mECR_mECR_5R",     
  # ECR8_rev = "mECR_mECR_8R",          
  # ECR9_rev = "mECR_mECR_9R",
  # ECR_anxiety_mean = "mECRanx",
  # ECR_avoidance_mean = "mECRavo",
  # Fear of Negative Evaluation Scale - Reversed Items: 2, 4, 7, 10
  FNES = paste0("FNES_FNES_", 1:12),
  # FNES2_rev = "FNES_FNES_2R",        
  # FNES4_rev = "FNES_FNES_4R",         
  # FNES7_rev = "FNES_FNES_7R",        
  # FNES10_rev = "FNES_FNES_10R",
  # FNES_mean = "FNES",
  # Rosenberg Self-Esteem Scale - Reversed Items: 3, 5, 8, 9, 10
  esteem = paste0("RSE_esteem_", 1:10),
  # esteem3_rev = "RSE_esteem_3R" ,              
  # esteem5_rev = "RSE_esteem_5R" ,               
  # esteem8_rev = "RSE_esteem_8R" ,              
  # esteem9_rev = "RSE_esteem_9R" ,               
  # esteem10_rev = "RSE_esteem_10R",
  # esteem_mean = "RSE",
  # Socioeconomic Status
  ladder = "socioeconomicStatus",
  # Rejection Sensitivity
  RS1a = "RS1a",
  RS1b = "RS1b",
  RS2a = "RS2a",
  RS2b = "RS2b",
  RS3a = "RS3a",
  RS3b = "RS3b",
  RS4a = "RS4a",
  RS4b = "RS4b",
  RS5a = "RS5a",
  RS5b = "RS5b",
  RS6a = "RS6a",
  RS6b = "RS6b",
  RS7a = "RS7a",
  RS7b = "RS7b",
  RS8a = "RS8a",
  RS8b = "RS8b",
  # Need-Threat Scale
  nts_T3_ = paste0("NTSmod_", 1:16),
  nts_T5_ = paste0("D2NTS_", 1:16)
  )

# Select out variables
NPSv2_public <- NPSv2_raw %>%
  select(unlist(NPSv2_vars))
```

## Dummy Coding
```{r}
# Effect coding and create dummy for participant and confederate desires
NPSv2_public <- NPSv2_public %>% 
  mutate(participant_desire_ec = case_when(participant_desire == 0 ~ -0.5,
                                           participant_desire == 1 ~ 0.5),
         confederate_desire_ec = case_when(confederate_desire == 0 ~ -0.5,
                                           confederate_desire == 1 ~ 0.5),
         desires_dummy = case_when(participant_desire == 0 &
                                     confederate_desire == 0 ~ "P0C0",
                                   participant_desire == 0 &
                                     confederate_desire == 1 ~ "P0C1",
                                   participant_desire == 1 &
                                     confederate_desire == 0 ~ "P1C0",
                                   participant_desire == 1 &
                                     confederate_desire == 1 ~ "P1C1"))

```



## Labeling Values

```{r}
# Read the dictionary from Web
NPSv2_dict_URL <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vSyh6WckkI1qXTXGTQ-2Dr2lvN4h_gHkgBoIZ90-oXSJm9KGdD8HJV6ByA7iJX-RMVGYKBOWFPEO9bj/pub?gid=0&single=true&output=csv"

# Read the variable dictionary google sheet
NPSv2_dict <- read_csv(NPSv2_dict_URL, col_types = cols())
# Set the variable labels
var_label(NPSv2_public) <- NPSv2_dict %>% 
  select(varname, label) %>% 
  dict_to_list()

# Date to datetime object
NPSv2_public <- NPSv2_public %>%
  mutate(across(ends_with("Date"),
                lubridate::as_datetime))

# Heart

# Valence

# Export Variable Dictionary
NPSv2_public %>% colnames() %>% tibble(varname = .) %>% write_excel_csv( here("codebooks/NPSv2_vars.csv"))

# Recode the Experiemntal Condition
add_labels_participant_desire <- function(x) {
  val_labels(x) <- c("Low Participant Desire" = 0,
                     "High Participant Desire" = 1)
  return(x)
}
NPSv2_public <- NPSv2_public %>%
  mutate_at(vars(c(participant_desire, confederate_desire)),
            add_labels_participant_desire)

# Confederate Desire
add_labels_confederate_desire <- function(x) {
  val_labels(x) <- c("Low Confederate Desire" = 0,
                     "High Confederate Desire" = 1)
  return(x)
}
NPSv2_public <- NPSv2_public %>%
  mutate_at(vars(confederate_desire),
            add_labels_confederate_desire)


# Rejection Manipulation
add_labels_0cont1rej <- function(x) {
  val_labels(x) <- c("Control" = 0,
                     "Rejection" = 1)
  return(x)
}
NPSv2_public <- NPSv2_public %>%
  mutate_at(vars(rejection),
            add_labels_0cont1rej)

# Race -- labeled

# ECR
add_labels_ECR <- function(x) {
  val_labels(x) <- c("Strongly disagree" = -3, "-2" = -2, "1" = -1,
                     "Neither disagree or agree" = 0, "1" = 1, "2" = 2,
                     "Strongly agree" = 3)
  return(x)
}

# NTS
NPSv2_public <- NPSv2_public %>% 
  mutate_at(vars(starts_with("nts")),
            add_labels_nts)
```

## Reverse Coding

```{r}
# Experience in Close Relationships - Reversed Items: 1, 5, 8, 9
ECR_rev_vars <- paste0("ECR", c(1, 5, 8, 9))
ECR_nonrev_vars <- setdiff(paste0("ECR", 1:12), ECR_rev_vars)
ECR_vars <- c(ECR_nonrev_vars, paste0(ECR_rev_vars, "R"))
# Avoidance Questions are Items 1, 3, 5, 7, 9, 11
ECR_avoidance_vars <- c("ECR1R", "ECR3", "ECR5R", "ECR7", "ECR9R", "ECR11")
# Anxiety Questions are 2, 4, 6, 8, 10, 12
ECR_anxiety_vars <- c("ECR2", "ECR4", "ECR6", "ECR8R", "ECR10", "ECR12")
## Add "R" to reversed variable names
NPSv2_public <- NPSv2_public %>% 
  rename_at(ECR_rev_vars, add_R)
## Reverse the values of the reversed variables with "R"
NPSv2_public <- NPSv2_public %>% 
  mutate_at(paste0(ECR_rev_vars, "R"), reverse_labelled_values)

# Fear of Negative Evaluation Scale - Reversed Items: 2, 4, 7, 10
FNES_rev_vars <- paste0("FNES", c(2, 4, 7, 10))
FNES_nonrev_vars <- setdiff(paste0("FNES", 1:12), FNES_rev_vars)
FNES_vars <- c(paste0(FNES_rev_vars, "R"), FNES_nonrev_vars)
## Add "R" to reversed variable names
NPSv2_public <- NPSv2_public %>% rename_at(FNES_rev_vars, add_R)
## Reverse the values of the reversed variables with "R"
NPSv2_public <- NPSv2_public %>% 
  mutate_at(paste0(FNES_rev_vars, "R"), reverse_labelled_values)

# Rosenberg Self-Esteem Scale - Reversed Items: 3, 5, 8, 9, 10
## Add "R" to reversed variable names
NPSv2_public <- NPSv2_public %>% rename_at(esteem_rev_vars, add_R)
## Reverse the values of the reversed variables with "R"
NPSv2_public <- NPSv2_public %>% 
  mutate_at(paste0(esteem_rev_vars, "R"), reverse_labelled_values)

# Rejection Sensitivity - Reverse b Items
NPSv2_public <- NPSv2_public %>% rename_at(vars(matches("\\db$")), add_R)
## Reverse the values of the reversed variables with "R"
NPSv2_public <- NPSv2_public %>% 
  mutate_at(vars(matches("\\dbR$")), reverse_labelled_values)

# Need-Threat Scale: Reversed Items: 1, 2, 3, 5, 7, 11, 14, 15, 16
NPSv2_nts_rev_vars <- paste0("nts_T", rep(c(3,5), each = 9), "_",
                             c(1, 2, 3, 5, 7, 11, 14, 15, 16))
NPSv2_nts_nonrev_vars <- setdiff(paste0("nts_T", rep(c(3,5), each = 16), "_", 1:16),
                                 NPSv2_nts_rev_vars)
## Add "R" to reversed variable names
NPSv2_public <- NPSv2_public %>% rename_at(NPSv2_nts_rev_vars, add_R)
## Reverse the values of the reversed variables with "R"
NPSv2_public <- NPSv2_public %>% 
  mutate_at(paste0(NPSv2_nts_rev_vars, "R"), function(x){100 - x})
```

## Calculate Scales

```{r}
# Experience in Close Relationship Scale - Reversed Items: 1, 5, 8, 9
ECR_rev_vars <- paste0("ECR", c(1, 5, 8, 9))
ECR_nonrev_vars <- setdiff(paste0("ECR", 1:12), ECR_rev_vars)
ECR_vars <- c(ECR_nonrev_vars, paste0(ECR_rev_vars, "R"))
# Avoidance Questions are Items 1, 3, 5, 7, 9, 11
ECR_avoidance_vars <- c("ECR1R", "ECR3", "ECR5R", "ECR7", "ECR9R", "ECR11")
# Anxiety Questions are 2, 4, 6, 8, 10, 12
ECR_anxiety_vars <- c("ECR2", "ECR4", "ECR6", "ECR8R", "ECR10", "ECR12")

# Attachment Avoidance - Mean
NPSv2_public$ECR_avoidance_mean <- NPSv2_public %>%
  select(all_of(ECR_avoidance_vars)) %>%
  aggregate_and_document_scale()

# Attachment Anxiety - Mean
NPSv2_public$ECR_anxiety_mean <- NPSv2_public %>%
  select(all_of(ECR_anxiety_vars)) %>%
  aggregate_and_document_scale()

# Fear of Negative Evaluation
NPSv2_public$FNES_mean <- NPSv2_public %>%
  select(all_of(FNES_vars)) %>%
  aggregate_and_document_scale()

# Rosenberg Self-Esteem Scale - Mean
NPSv2_public$esteem_mean <- NPSv2_public %>%
  select(all_of(esteem_vars)) %>%
  aggregate_and_document_scale()

# Rejection Sensitivity - Product
NPSv2_public <- NPSv2_public %>% 
  # First, Multiply the a * b
  mutate(RS1_product = RS1a * RS1bR, RS2_product = RS2a * RS2bR,
         RS3_product = RS3a * RS3bR, RS4_product = RS4a * RS4bR,
         RS5_product = RS5a * RS5bR, RS6_product = RS6a * RS6bR,
         RS7_product = RS7a * RS7bR, RS8_product = RS8a * RS8bR)
NPSv2_public$RS_mean <- NPSv2_public %>%
  select(RS1_product:RS8_product) %>%
  aggregate_and_document_scale()

# Need-Threat Scale ------------------------------------------------------------
# Belonging - Items 2, 3, 4 (Include Item 1)
belonging_T3_vars <- c("nts_T3_1R", "nts_T3_2R", "nts_T3_3R", "nts_T3_4")
belonging_T5_vars <- c("nts_T3_1R", "nts_T5_2R", "nts_T5_3R", "nts_T5_4")
# Time 3
NPSv2_public$nts_T3_belonging_mean <- NPSv2_public %>%
  select(all_of(belonging_T3_vars)) %>%
  aggregate_and_document_scale()
# Time 5
NPSv2_public$nts_T5_belonging_mean <- NPSv2_public %>%
  select(all_of(belonging_T5_vars)) %>%
  aggregate_and_document_scale()

# Self_Esteem - Items: 11, 12, 13
esteem_T3_vars <- c("nts_T3_11R", "nts_T3_12", "nts_T3_13")
esteem_T5_vars <- c("nts_T5_11R", "nts_T5_12", "nts_T5_13")
# Time 3
NPSv2_public$nts_T3_esteem_mean <- NPSv2_public %>%
  select(all_of(esteem_T3_vars)) %>%
  aggregate_and_document_scale()
# Time 5
NPSv2_public$nts_T5_esteem_mean <- NPSv2_public %>%
  select(all_of(esteem_T5_vars)) %>%
  aggregate_and_document_scale()

# Control 
control_T3_vars <- c("nts_T3_8", "nts_T3_9", "nts_T3_10")
control_T5_vars <- c("nts_T5_8", "nts_T5_9", "nts_T5_10")
# Time 3
NPSv2_public$nts_T3_control_mean <- NPSv2_public %>%
  select(all_of(control_T3_vars)) %>%
  aggregate_and_document_scale()
# Time 5
NPSv2_public$nts_T5_control_mean <- NPSv2_public %>%
  select(all_of(control_T5_vars)) %>%
  aggregate_and_document_scale()
# Meaning - Items 5R, 6, 7R
meaning_T3_vars <- c("nts_T3_5R", "nts_T3_6", "nts_T3_7R")
meaning_T5_vars <- c("nts_T5_5R", "nts_T5_6", "nts_T5_7R")
# Time 3
NPSv2_public$nts_T3_meaning_mean <- NPSv2_public %>%
  select(all_of(meaning_T3_vars)) %>%
  aggregate_and_document_scale()
# Time 5
NPSv2_public$nts_T5_meaning_mean <- NPSv2_public %>%
  select(all_of(meaning_T5_vars)) %>%
  aggregate_and_document_scale()

# Overall 
## Time 3 
NPSv2_public$nts_T3_mean <- NPSv2_public %>%
  select(all_of(c(belonging_T3_vars, esteem_T3_vars,
                meaning_T3_vars, control_T3_vars))) %>%
  aggregate_and_document_scale()
## Time 5
NPSv2_public$nts_T5_mean <- NPSv2_public %>%
  select(all_of(c(belonging_T5_vars, esteem_T5_vars,
                meaning_T5_vars, control_T5_vars))) %>%
  aggregate_and_document_scale()
```

```{r s1e-saving-reliabilities}
# save reliability object for caching
s1e_reliability_data <- compute_reliabilities(NPSv2_public) %>% get_reliability_output()
# compress and save (otherwise 5GB < file size)
write_rds(s1e_reliability_data, here("data_public", "reliability", "s1e_reliability.rds"), compress = "gz")
```

## Save the Public Dataset

```{r}
# .csv 
write_csv(NPSv2_public, here("data_public/Study1e_public.csv"))
# .rds
write_rds(NPSv2_public, here("data_public/Study1e_public.rds"))
```
