---
title: "Study 3 Data Preparation and Codebook"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    code_folding: 'hide'
    self_contained: true
  pdf_document:
    toc: yes
    toc_depth: 4
    latex_engine: xelatex

---


```{r}
library(tidyverse)
library(haven) # to read data from .sav format from Qualtrics
library(codebook) # to generate codebook
library(here)

# Codebook
knitr::opts_chunk$set(
  warning = TRUE, # show warnings during codebook generation
  message = TRUE, # show messages during codebook generation
  error = FALSE, # do not interrupt codebook generation in case of errors,
                # usually better for debugging
  echo = TRUE  # show R code
)
ggplot2::theme_set(ggplot2::theme_bw())

```

# Load Data
Download the .sav (SPSS) file from Qualtrics and load it with `haven()`.
```{r}
# Load data
s3_sav <- "Study3.sav"
s3_df <- haven::read_sav(here("data", s3_sav))
```

# Data Preparation

## Drop Unneded Variables and Unfinished Responses
Dropping variables such as IP Address, and panel metadata from Qualtrics. In addition, I'm dropping the location information since they are not used in my study. I'm also excluding entries that had a blank condition values as unfinished responses.
```{r}
s3_df <- s3_df %>% 
  select(-IPAddress,
         -(RecipientLastName:RecipientEmail),
         -ExternalReference,
         -LocationLatitude,
         -LocationLongitude)
# Drop Unfinished Responses (Responses without conditions are unfinished )
s3_df <- s3_df %>% 
  filter(parasocial != "")
# Hash ID
s3_df <- s3_df %>% mutate(PID = map_chr(id, openssl::sha2),
                          ResponseId = map_chr(ResponseId, openssl::sha2)) %>% 
  select(-id)
```

## Scale Variables

Scaled variables were
- On-The-Fly Measure of Social World (`OTF_Social_World_1:OTF_Social_World_4`) - No reversed items
- Player Character Identification (`PC_Identification_1:PC_Identification_6`) - No reversed items  
```{r}
# On-the-fly Measure of Social World ----------------------------------------
s3_df$OTF_Social_World <- s3_df %>% select(OTF_Social_World_1:OTF_Social_World_4) %>% aggregate_and_document_scale()

# Player Character Identifiaction ----------------------------------------
s3_df$PC_Identification <- s3_df %>% select(PC_Identification_1:PC_Identification_6) %>% aggregate_and_document_scale()

# Enjoyment  ----------------------------------------
enjoyment_rev_items <- paste0("enjoyment_", c(3)) # Reversed Item
s3_df <- s3_df %>% 
  # Add "R" to the reversed items variable names
  rename_at(enjoyment_rev_items, add_R) %>% 
  # Apply function to reverse the items
  mutate_at(paste0(enjoyment_rev_items, "R"), reverse_labelled_values)
# Aggregate as a scale
s3_df$Enjoyment <- s3_df %>% select(starts_with("Enjoyment_")) %>%
  aggregate_and_document_scale()

```

## Variables for Gender, Race, Parasocial Relationship Groups, Attention Check
```{r}
# Gender ---------------------------------------------------------------
s3_df <- s3_df %>% 
  mutate(across(starts_with("Gender"),
                to_factor)) %>%
  unite("Gender_Identity", Gender_1:Gender_7_TEXT,
        remove = FALSE, na.rm = TRUE, sep = " & ") %>%
  # Remove trailing "&"
  mutate(Gender_Identity = gsub('^\\s& |\\s& $', '', Gender_Identity)) %>%
  # Gropu into Female, Male, and Non-FM
  mutate(Gender_Identity_3GP = case_when(Gender_Identity == "Female" ~ "Female",
                                         Gender_Identity == "Male" ~ "Male",
                                         TRUE ~ "Other"))
## Effect Coding Gender
s3_df <- s3_df %>% 
  mutate(Gender_Identity_2GP_EC = case_when(Gender_Identity == "Female" ~ "Female",
                                         Gender_Identity == "Male" ~ "Male"),
         Gender_Identity_2GP_EC = case_when(Gender_Identity == "Female" ~ .5,
                                         Gender_Identity == "Male" ~ -.5))

# Race ------------------------------------------------------------
s3_df <- s3_df %>% 
  mutate(across(starts_with("Race_"),
                to_factor)) %>%
  unite("Race", Race_1:Race_6_TEXT,
        remove = FALSE, na.rm = TRUE, sep = " & ") %>%
  # Remove trailing "&"
  mutate(Race = gsub('^\\s& |\\s& $', '', Race)) %>%
  # Grouping in to White 
  mutate(Race_6GP = case_when(Race == "Native American" ~ "Native American",
                              Race == "Black/African-American" ~ "Black/African-American",
                              Race == "White" ~ "White",
                              Race == "Asian" ~ "Asian",
                              Race == "Pacific Islander" ~ "Pacific Islander",
                              TRUE ~ "Other/Multiracial"))

# Parasocial Relationships Manipulation Check ------------------------------
# Create variable for parasocial values 
parasocial_labels <- c("No Interaction with NPC",
                       "No Parasocial Relationship with NPC",
                       "Formed Parasocial Relationship with NPC")

# Add the 
s3_df <- s3_df %>% 
  mutate(parasocial_MC_group = 
           case_when(Interact_with_NPC == 2 ~ 1,
                     Interact_with_NPC == 1 & IOS == 0 ~ 2,
                     Interact_with_NPC == 1 & IOS > 0 ~ 3),
         parasocial_MC_group = ordered(parasocial_MC_group,
                                       levels = c(1, 2, 3),
                                       labels = parasocial_labels))

# Attention Check ---------------------------------------------------------------
s3_df <- s3_df %>% 
  # Rejection Attention Check
  mutate(attention_rejection_correct = 
           case_when(Attention_Rejection == 1 ~ TRUE,
                     TRUE ~ FALSE)) %>% 
  # Parasocial Relationship Attention Check
  mutate(attention_parasocial_correct = 
           case_when(parasocial == "High" & Attention_Sashu == 1 ~ TRUE,
                     parasocial == "Low" & Attention_Sashu == 3 ~ TRUE,
                     TRUE ~ FALSE)) %>% 
  # Social World Attention Check
  mutate(attention_social_world_correct = 
           case_when(social_world == "High" & Attention_Story == 1 ~ TRUE,
                     social_world == "Low" & Attention_Story == 3 ~ TRUE,
                     TRUE ~ FALSE)) %>% 
  # All Attention Checks
  mutate(attention_all_correct = 
           case_when(attention_rejection_correct == TRUE &
                       attention_parasocial_correct == TRUE &
                       attention_social_world_correct == TRUE ~ TRUE,
                     TRUE ~ FALSE))

# Convert all time variables to date and time 
s3_df <- s3_df %>% 
  mutate(across(starts_with("t_"), lubridate::as_datetime))

# Calculate Video Game Playtime ---------------------------------------------------------------
s3_df <- s3_df %>% 
  mutate(RPG_playtime = t_RPGplay_submit - t_RPGinst_submit)

```

# Rename Condition Labels
```{r}
s3_df <- s3_df %>%
  mutate(parasocial = case_when(parasocial == "High" ~ "High Parasocial",
                                parasocial == "Low" ~ "Low Parasocial"),
         social_world = case_when(social_world == "High" ~ "High Social World",
                                  social_world == "Low" ~ "Low Social World"))
```

# Effect Coding Parasocial and Social World
```{r}
s3_df <- s3_df %>%
  mutate(parasocial_EC = case_when(parasocial == "High Parasocial" ~ .5,
                                parasocial == "Low Parasocial" ~ -.5),
         social_world_EC = case_when(social_world == "High Social World" ~ .5,
                                  social_world == "Low Social World" ~ -.5))

```

# Effect Coding Gender
```{r}
s3_df <- s3_df %>%
  mutate(parasocial_EC = case_when(parasocial == "High Parasocial" ~ .5,
                                parasocial == "Low Parasocial" ~ -.5),
         social_world_EC = case_when(social_world == "High Social World" ~ .5,
                                  social_world == "Low Social World" ~ -.5))

```

# Save Reliabilities
```{r s3-save-reliabilities}
# reliabilties
s3_reliabilities <- s3_df %>% compute_reliabilities() %>%
  get_reliability_output()
# Get the list of cronbach's alpha 
s3_reliabilities %>% 
  # compress and save (otherwise 5GB < file size)
  write_rds(here("data_public", "reliability", "s3_reliability.rds"),
            compress = "gz")
```


# Export Public Dataset
I exported the data to a cleaned public dataset for analysis. Since the dataset will be public, and the answers to the open-ended responses could potentially be personally identifiable, I dropped the answers to the following open-ended responses.
- Rejection essay
- Participants' responses about the purpose of the study
- Participants' responses to share anything about the study
I exported the dataset in both .rds and .csv formats. (`Study3_public.rds`, `Study3_public.csv`)
```{r}
# Drop write-in responses for the public dataset
s3_public <- s3_df %>% select(-Rejection_Essay,
                              -Study_Purpose,
                              -Share_Anything,
                              -Race_6_TEXT,
                              -Race,
                              -Relationship_7_TEXT,
                              -Gender_7_TEXT,
                              -Sexori_6_TEXT)
# Save as .rds and .csv 
write_rds(s3_public, here("data_public", "Study3_public.rds"))
write_csv(s3_public, here("data_public", "Study3_public.csv"))
```

# Codebook
I use `codebook` to add metadata.
```{r}
# Study Name 
metadata(s3_df)$name <- "Nami Sunami's Dissertation - Study 3"
# Study Description
metadata(s3_df)$description <- paste0("

### Download link
[Open Science Framework](https://osf.io/XXXXX)

### Preprocessing
All rating variables (i.e., actual choice, friendship, short-term relationship etc.) were corrected for prior acquaintance, which means that dates wih prior acquaintance were excluded (set to missing) on a dyadic basis.

Variables are labeled in SPSS. 

### A list of important abbreviations, prefixes and suffixes:

* PSI = Parasocial Interaction 
* PC = Player Character
")

# Study Identifier 
metadata(s3_df)$identifier <- "https://osf.io/jvk3u/"

# Date published 
metadata(s3_df)$datePublished <- "2015-10-07"

# Creator information 
metadata(s3_df)$creator <- list(
  "@type" = "Person",
  givenName = "Nami", familyName = "Sunami",
  email = "naoyuki.sunami@gmail.com", 
  affiliation = list("@type" = "Organization",
                     name = "University of Delaware, USA"))

# Citation Information
metadata(s3_df)$citation <- "XXXXXXXXX"
# URL
metadata(s3_df)$url <- "https://osf.io/XXXXXXXX/"
# Temporal Coverage
metadata(s3_df)$temporalCoverage <- "2021"
# Spacial Coverage 
metadata(s3_df)$spatialCoverage <- "Delaware, United States
# Distribution" 
metadata(s3_df)$distribution = list(
  list("@type" = "DataDownload",
       "requiresSubscription" = "http://schema.org/True",
       "encodingFormat" = "https://www.loc.gov/preservation/digital/formats/fdd/fdd000469.shtml",
       contentUrl = "https://osf.io/XXXX/download")
)

```

```{r "render coderbook"}
codebook(s3_df)
# Save the codebook summary information as csv
s3_codebook_tibble <- codebook_table(s3_df)
write_csv(s3_codebook_tibble,
          here("codebooks", "Study 3 - Codebook Table.csv"))
```


